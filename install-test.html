<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GIAP · Install-Test</title>

  <!-- Manifest mit ABSOLUTEM Pfad zum Repo -->
  <link rel="manifest" href="/GIAP-global-idea-addressing-protocol/manifest.webmanifest?v=2">
<meta name="theme-color" content="#0f172a">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:0;background:#111;color:#fff}
    .card{max-width:860px;margin:18px auto;background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:16px}
    h1{margin:0 0 10px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #fff;background:#fff;color:#111;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    #log{white-space:pre-wrap;font-family:ui-monospace, Menlo, Consolas, monospace;background:#0b0b0b;border-radius:8px;padding:10px;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Installations-Test</h1>
    <p>Diese Seite zeigt dir, ob Chrome die PWA-Installation erlaubt.</p>
    <button id="installBtn" disabled>Installieren</button>
    <div id="log">Starte Diagnose…</div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const btn   = document.getElementById('installBtn');
    const log = (m) => { console.log('[TEST]', m); logEl.textContent += '\n' + m; };

    // 1) Service Worker registrieren (ABSOLUTER Pfad + Scope)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/GIAP-global-idea-addressing-protocol/sw.js', {
        scope: '/GIAP-global-idea-addressing-protocol/'
      }).then(reg => {
        log('SW registered: ' + reg.scope);
      }).catch(err => log('SW error: ' + err));
    } else {
      log('Kein Service-Worker-Support im Browser.');
    }

    // 2) Install-Flow
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btn.disabled = false;
      log('beforeinstallprompt: OK – Button freigegeben.');
    });

    btn.addEventListener('click', async () => {
      if (!deferredPrompt) { log('Kein Prompt verfügbar (Button sollte deaktiviert sein).'); return; }
      btn.disabled = true;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      log('userChoice: ' + (choice && choice.outcome));
      deferredPrompt = null;
    });

    // 3) Diagnose: steht ein SW „unter Kontrolle“?
    (async () => {
      try { await navigator.serviceWorker.ready; } catch {}
      const controlled = !!navigator.serviceWorker.controller;
      log('SW controlled: ' + controlled);
      if (!controlled) log('Hinweis: Einmal neu laden, damit der neue SW die Seite kontrolliert.');
    })();
  </script>
</body>
</html>
