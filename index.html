<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GIAP · Churchen (MVP)</title>

  <!-- Manifest + Theme (RELATIVE Pfade für GitHub Pages) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">

  <style>
    :root{--w:900px}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    header{padding:0;background:#fff;border-bottom:1px solid #eee}
    main{max-width:var(--w);margin:0 auto;padding:18px}
    h1{margin:0 0 6px;font-size:28px}
    h2{margin:0 0 10px}
    .topbar{max-width:var(--w);margin:0 auto;padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 4px 18px rgba(0,0,0,.04)}
    .hero{max-width:var(--w);margin:0 auto;padding:24px 16px 16px;text-align:center}
    .hero h1{font-size:32px;margin:0 0 8px}
    .lead{color:#555}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    textarea{width:100%;min-height:140px;padding:12px;border:1px solid #ddd;border-radius:10px;font:inherit}
    input[type=text]{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font:inherit}
    button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    button[disabled]{opacity:.6;cursor:not-allowed}
    code{background:#f2f2f2;border-radius:6px;padding:2px 6px}
    .muted{color:#666;font-size:14px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px;vertical-align:top}
    .pill-btn{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #111;background:#fff;color:#111;font-size:12px;cursor:pointer}
    .pill-btn + .pill-btn{margin-left:6px}
    #judge-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:10000;display:grid;place-items:center;padding:16px}
    #judge-card{background:#fff;border-radius:12px;max-width:820px;width:100%;padding:18px;box-shadow:0 12px 36px rgba(0,0,0,.25)}
  </style>
</head>
<body>

<header>
  <div style="background:#0f172a;color:#fff">
    <div class="topbar">
      <div style="font-weight:700">GIAP · Churchen MVP</div>
      <div class="row" style="margin-top:0">
        <button id="btn-open-chatgpt" class="secondary" title="In neuem Tab">ChatGPT öffnen</button>
        <button id="btn-pwa-install" class="secondary" disabled>App installieren</button>
      </div>
    </div>
  </div>
  <div class="hero">
    <h1>Every Idea. One Click. Global Reach.</h1>
    <p class="lead">GIAP gibt jeder Idee beim Entstehen eine Adresse – lokal, privat, sofort.</p>
    <p id="pwa-hint" class="muted"></p>
  </div>
</header>

<main>
  <!-- 1) Eingabe -->
  <section class="card" id="demo">
    <h2>1) Capture Idea → Assign Address</h2>
    <textarea id="idea" placeholder="Write your idea here…"></textarea>
    <div class="row">
      <button id="btn-churchen">Assign Address (churchen)</button>
      <button id="btn-clear" class="secondary">Clear</button>
    </div>
    <p class="muted">Alles läuft lokal in deinem Browser (LocalStorage).</p>
  </section>

  <!-- Ergebnis -->
  <section class="card" id="result" style="display:none">
    <h2>Address</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div><label>IdeaID</label><input id="ideaId" type="text" readonly /></div>
      <div><label>Content Hash (SHA-256)</label><input id="hash" type="text" readonly /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn-copy" class="secondary">Copy IdeaID</button>
      <button id="btn-copy-url" class="secondary">Copy Permalink</button>
    </div>
    <p class="muted">Permalink: <code>?id=&lt;IdeaID&gt;</code></p>
  </section>

  <!-- Registry -->
  <section class="card">
    <h2>2) Local Register</h2>
    <table class="table" id="tbl">
      <thead><tr><th>IdeaID</th><th>Preview</th><th>Date</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:8px">
      <button id="btn-export" class="secondary">Export (.json)</button>
      <label class="secondary" style="border:1px solid #111;padding:9px 12px;border-radius:10px;background:#fff;cursor:pointer">
        Import (.json)
        <input type="file" id="file-import" accept="application/json" style="display:none">
      </label>
    </div>
  </section>

  <!-- Tags -->
  <section class="card">
    <h2>3) (Optional) Tags</h2>
    <p class="muted">Für spätere Relevanz-Matches – wird mit der Idee lokal gespeichert.</p>
    <input id="tags" type="text" placeholder="e.g. water, solar, protocol" />
  </section>

  <div class="row" style="justify-content:flex-end;margin-top:10px">
    <button id="judge-btn" class="secondary">Judge This Idea</button>
  </div>
</main>

<script>
/* ===== App-Logik (Churchen, Registry) ===== */
(function(){
  'use strict';
  const STORAGE_KEY = 'giap_registry_v1';
  const MAX_ENTRIES = 1000;
  const cap = (arr, n) => arr.sort((a,b)=>a.date - b.date).slice(-n);
  const $ = sel => document.querySelector(sel);

  const taIdea = $('#idea'), inpTags = $('#tags');
  const secResult = $('#result'), outId = $('#ideaId'), outHash = $('#hash');
  const tblBody = document.querySelector('#tbl tbody');

  const todayStr = ()=>new Date().toISOString().slice(0,10).replace(/-/g,'');
  const parseTags = s => (s||'').split(',').map(t=>t.trim()).filter(Boolean);
  const readReg = () => { try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; } };
  const writeReg = v => localStorage.setItem(STORAGE_KEY, JSON.stringify(v));
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  const ideaIdFrom = hp => `giap:${todayStr()}-${hp}`;

  function render(){
    const list = readReg().sort((a,b)=>b.date-a.date);
    tblBody.innerHTML = '';
    for (const it of list){
      const tr = document.createElement('tr');

      const tdId = document.createElement('td');
      const a = document.createElement('a'); a.href = '?id='+encodeURIComponent(it.id); a.textContent = it.id;
      const bCopy = document.createElement('button'); bCopy.textContent='kopieren'; bCopy.className='pill-btn';
      bCopy.onclick = async (e)=>{e.preventDefault(); try{ await navigator.clipboard.writeText(it.id);}catch{} };
      const bShare = document.createElement('button'); bShare.textContent='teilen'; bShare.className='pill-btn';
      bShare.onclick = async (e)=>{ e.preventDefault(); const url = location.origin+location.pathname+'?id='+encodeURIComponent(it.id);
        if(navigator.share){ try{ await navigator.share({title:'GIAP Idea', text:it.id, url}); }catch{} } else {
          try{ await navigator.clipboard.writeText(url);}catch{} }
      };
      tdId.appendChild(a); tdId.appendChild(document.createTextNode(' '));
      tdId.appendChild(bCopy); tdId.appendChild(document.createTextNode(' ')); tdId.appendChild(bShare);
      tr.appendChild(tdId);

      const tdPrev = document.createElement('td'); tdPrev.textContent = it.title || '(no title)'; tr.appendChild(tdPrev);
      const tdDate = document.createElement('td'); tdDate.textContent = new Date(it.date||Date.now()).toLocaleString(); tr.appendChild(tdDate);

      const tdAct = document.createElement('td');
      const bLoad = document.createElement('button'); bLoad.textContent='laden'; bLoad.className='pill-btn';
      bLoad.onclick = ()=>{ taIdea.value=it.title||''; inpTags.value=(it.tags||[]).join(', '); window.scrollTo({top:0,behavior:'smooth'}); };
      const bDel = document.createElement('button'); bDel.textContent='löschen'; bDel.className='pill-btn';
      bDel.onclick = ()=>{ const cur = readReg().filter(x=>x.id!==it.id); writeReg(cur); render(); };
      tdAct.appendChild(bLoad); tdAct.appendChild(document.createTextNode(' ')); tdAct.appendChild(bDel);
      tr.appendChild(tdAct);

      tblBody.appendChild(tr);
    }
  }

  document.getElementById('btn-churchen').addEventListener('click', async ()=>{
    const title = (taIdea.value||'').trim();
    const tags = parseTags(inpTags.value);
    if (!title){ alert('Please write your idea first.'); return; }
    const hash = await sha256Hex(title + '||' + tags.join('|'));
    const id = ideaIdFrom(hash.slice(0,10));
    const entry = { id, title, tags, hash, date: Date.now() };

    const reg = readReg();
    if (!reg.some(x=>x.id===id)) reg.push(entry);
    writeReg(cap(reg, MAX_ENTRIES));

    outId.value = id; outHash.value = hash; secResult.style.display = '';
    render();
  });

  document.getElementById('btn-clear').addEventListener('click', ()=>{
    taIdea.value=''; inpTags.value=''; secResult.style.display='none'; outId.value=''; outHash.value='';
  });

  document.getElementById('btn-copy').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(outId.value||''); }catch{} });
  document.getElementById('btn-copy-url').addEventListener('click', async ()=>{
    const url = location.origin + location.pathname + '?id=' + encodeURIComponent(outId.value||'');
    try{ await navigator.clipboard.writeText(url); }catch{}
  });

  (function handleDeepLink(){
    const id = new URLSearchParams(location.search).get('id'); if(!id) return;
    const reg = readReg(); const found = reg.find(x=>x.id===id);
    outId.value = id; outHash.value = found? (found.hash||'') : ''; secResult.style.display = '';
    document.getElementById('result').scrollIntoView({behavior:'smooth'});
  })();

  // Judge demo (klein, wie gehabt)
  function jaccard(a=[], b=[]){
    const A=new Set(a.map(x=>String(x).toLowerCase()));
    const B=new Set(b.map(x=>String(x).toLowerCase()));
    const inter=[...A].filter(x=>B.has(x)).length;
    const uni=new Set([...A,...B]).size||1;
    return inter/uni;
  }
  function ensureMin2(){
    let r = readReg();
    if (r.length >= 2) return r;
    const t = todayStr();
    const seed = [
      { id:`giap:${t}-seedA`, title:'Student in Nairobi: water filter', tags:['water','innovation','sustainability'], date: Date.now() },
      { id:`giap:${t}-seedB`, title:'Solar saline plantage', tags:['solar','desalination','sustainability'], date: Date.now() }
    ];
    if (r.length === 0) r = seed; else if (r.length === 1) r.push(seed[1]);
    writeReg(r); return r;
  }
  function showOverlay(a,b,score){
    const old = document.getElementById('judge-overlay'); if(old) old.remove();
    const o = document.createElement('div'); o.id='judge-overlay';
    const c = document.createElement('div'); c.id='judge-card';
    c.innerHTML = `
      <h3 style="margin:0 0 10px">How GIAP links ideas</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div style="border:1px solid #eee;border-radius:8px;padding:10px">
          <div style="font-weight:700">Idea A</div>
          <div><small>${a.id}</small></div>
          <div style="margin-top:6px">${a.title||'(no title)'}</div>
          <div style="color:#555;margin-top:6px"><small>Tags: ${(a.tags||[]).join(', ')||'—'}</small></div>
        </div>
        <div style="border:1px solid #eee;border-radius:8px;padding:10px">
          <div style="font-weight:700">Idea B</div>
          <div><small>${b.id}</small></div>
          <div style="margin-top:6px">${b.title||'(no title)'}</div>
          <div style="color:#555;margin-top:6px"><small>Tags: ${(b.tags||[]).join(', ')||'—'}</small></div>
        </div>
      </div>
      <div style="margin:12px 0 6px">Similarity (tags): <b>${(score*100).toFixed(0)}%</b></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="judge-close" class="secondary">Close</button>
      </div>`;
    o.appendChild(c); document.body.appendChild(o);
    document.getElementById('judge-close').onclick=()=>o.remove();
  }
  document.getElementById('judge-btn').addEventListener('click', ()=>{
    const reg = ensureMin2();
    const i = Math.floor(Math.random()*reg.length);
    let j = Math.floor(Math.random()*reg.length); if (reg.length>1) while (j===i) j = Math.floor(Math.random()*reg.length);
    const A = reg[i], B = reg[j];
    showOverlay(A,B, jaccard(A.tags||[], B.tags||[]));
  });

  // ChatGPT öffnen
  document.getElementById('btn-open-chatgpt').addEventListener('click', ()=>{
    const url = 'https://chat.openai.com/';
    window.open(url, '_blank', 'noopener');
  });

  // Initial render
  render();
})();
</script>

<script>
/* ===== PWA: SW registrieren + Install-Button steuern ===== */
(function(){
  const btn  = document.getElementById('btn-pwa-install');
  const hint = document.getElementById('pwa-hint');
  const say  = (m)=>{ if(hint) hint.textContent = m||''; console.log('[PWA]', m); };

  // SW registrieren (RELATIV, Scope = ./)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js', { scope: './' })
      .then(r => console.log('SW registered:', r.scope))
      .catch(e => console.error('SW error:', e));
  }

  // Bereits installiert?
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                    || (navigator.standalone === true);
  if (isStandalone) {
    btn.disabled = true;
    say('App ist installiert – öffne vom Homescreen.');
    return;
  }

  // beforeinstallprompt-Flow (Chrome/Edge)
  let deferred = null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferred = e;
    btn.disabled = false;
    say('Bereit zur Installation.');
  });

  btn.addEventListener('click', async ()=>{
    if (!deferred) { say('Noch nicht bereit. Seite evtl. neu laden oder Browser-Menü nutzen.'); return; }
    btn.disabled = true;
    deferred.prompt();
    try {
      const res = await deferred.userChoice;
      say(res && res.outcome === 'accepted' ? 'Installation gestartet.' : 'Installation abgebrochen.');
    } finally {
      deferred = null;
    }
  });

  // Diagnose: wenn nach 2s kein Event kam, Hinweis geben
  setTimeout(()=>{ if (!deferred) say('Tipp: Seite einmal neu laden, kurz benutzen oder Menü „App installieren“ verwenden.'); }, 2000);
})();
</script>

</body>
</html>
