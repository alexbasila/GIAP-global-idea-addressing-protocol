<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flaschenpost (GIAP)</title>

  <!-- Manifest: mit Cache-Buster erzwingen wir das Neuladen -->
  <link rel="manifest" href="/GIAP-global-idea-addressing-protocol/manifest.webmanifest?v=svg1" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root { color-scheme: light dark }
    * { box-sizing: border-box }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
           background:#0b0f19; color:#fff; min-height:100dvh; display:grid; place-items:center; }
    .card { max-width:820px; width:100%; background:#0f172a; border:1px solid #243045;
            border-radius:14px; padding:20px; box-shadow:0 12px 28px rgba(0,0,0,.35); }
    h1 { margin:0 0 6px; font-size:28px }
    p  { margin:0 0 14px; opacity:.9 }
    button { padding:10px 16px; border-radius:10px; border:1px solid #fff; background:#fff; color:#0f172a;
             font-weight:700; cursor:pointer }
    button:disabled { opacity:.5; cursor:not-allowed }
    #log { margin-top:12px; white-space:pre-wrap; font:13px ui-monospace, Menlo, Consolas, monospace;
           background:#0a0e18; border:1px solid #1b2233; border-radius:10px; padding:10px }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    small.muted { opacity:.85 }
  </style>
</head>
<body>
  <main class="card">
    <h1>Flaschenpost (GIAP) · Install</h1>
    <p>Wenn der Button aktiv wird, kannst du die PWA installieren.</p>

    <div class="row">
      <button id="installBtn" disabled>Installieren</button>
      <small id="hint" class="muted"></small>
    </div>

    <div id="log">Log:</div>
  </main>

  <script>
    const logEl = document.getElementById('log');
    const hint  = document.getElementById('hint');
    const btn   = document.getElementById('installBtn');
    const log   = m => { console.log('[PWA]', m); logEl.textContent += '\\n' + m; };
    const say   = t => { hint.textContent = t; log(t); };

    // 1) Service Worker registrieren (absoluter Pfad + Scope für GitHub Pages)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/GIAP-global-idea-addressing-protocol/sw.js', {
          scope: '/GIAP-global-idea-addressing-protocol/'
        }).then(reg => {
          log('SW registered: ' + reg.scope);
          return navigator.serviceWorker.ready;
        }).then(() => {
          const controlled = !!navigator.serviceWorker.controller;
          say(controlled ? 'SW ok ✓ – warte auf Install-Event …'
                         : 'SW registriert → einmal neu laden, dann kontrolliert er die Seite.');
        }).catch(e => say('SW error: ' + e));
      });
    } else {
      say('Kein Service-Worker-Support im Browser.');
    }

    // 2) Install-Flow
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btn.disabled = false;
      say('Bereit zur Installation. Tippe auf „Installieren“.');
    });

    btn.addEventListener('click', async () => {
      if (!deferredPrompt) { say('Noch kein Install-Event. Seite ggf. neu laden.'); return; }
      btn.disabled = true;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      say('Ergebnis: ' + (choice && choice.outcome));
      deferredPrompt = null;
    });

    window.addEventListener('appinstalled', () => say('appinstalled ✓'));
  </script>
</body>
</html>
